<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡πÄ‡∏î‡πÇ‡∏°‡πà‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡∏î (Live OCR)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ‡πÇ‡∏´‡∏•‡∏î Tesseract.js ‡∏à‡∏≤‡∏Å CDN -->
  <script src="https://unpkg.com/tesseract.js@v4.1.1/dist/tesseract.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #f3f4f6;
      display: flex;
      justify-content: center;
    }
    .container {
      max-width: 960px;
      width: 100%;
    }
    h1 {
      font-size: 1.6rem;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #4b5563;
      margin-bottom: 16px;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 16px;
    }
    @media (max-width: 768px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: #ffffff;
      padding: 16px;
      border-radius: 14px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
    }
    .card-title {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 1rem;
      color: #111827;
    }
    .card-desc {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .field {
      margin-bottom: 10px;
    }
    .field label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #374151;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.1s ease;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }
    .btn-primary {
      background: #2563eb;
      color: white;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }
    .preview-wrapper {
      margin-top: 8px;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #cameraPreview {
      width: 100%;
      max-height: 260px;
      border-radius: 10px;
      background: #000;
      object-fit: cover;
    }
    #capturedImage {
      max-width: 100%;
      max-height: 140px;
      border-radius: 10px;
      border: 1px dashed #d1d5db;
      display: none;
      object-fit: contain;
      background: #f9fafb;
    }
    .status {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #6b7280;
    }
    .status.success {
      color: #15803d;
    }
    .status.error {
      color: #b91c1c;
    }
    .pill {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #eef2ff;
      color: #4f46e5;
      margin-bottom: 6px;
    }
    .footer-note {
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 8px;
      line-height: 1.4;
    }
    .field input,
    .field textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      outline: none;
    }
    .field input:focus,
    .field textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb33;
    }
    #ocrRaw {
      font-size: 0.75rem;
      color: #4b5563;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‡πÄ‡∏î‡πÇ‡∏°‡πà‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡∏î (Live OCR)</h1>
    <p class="subtitle">
      ‡∏Å‡∏î ‚Äú‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á &amp; ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡∏à‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á  
      ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ OCR ‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á ‡πÜ ‡πÅ‡∏•‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•, ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î, ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ‡∏°‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    </p>

    <div class="layout">
      <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏Å‡∏•‡πâ‡∏≠‡∏á + Live Scan -->
      <div class="card">
        <div class="pill">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 : ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á &amp; ‡∏™‡πà‡∏≠‡∏á‡∏ö‡∏±‡∏ï‡∏£</div>
        <div class="card-title">‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡∏î (‡∏ñ‡∏∑‡∏≠‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏ü‡∏£‡∏°)</div>
        <p class="card-desc">
          ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô HTTPS (‡πÄ‡∏ä‡πà‡∏ô Vercel / Netlify / localhost ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô secure)  
          ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á &gt; ‡πÄ‡∏≠‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡∏à‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î &gt; ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å ‡πÜ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        </p>

        <div class="field" style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn btn-primary" id="openCameraButton">
            üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á &amp; ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô
          </button>
          <button class="btn btn-secondary" id="stopScanButton" disabled>
            ‚úñÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô / ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
          </button>
        </div>

        <div class="preview-wrapper">
          <video id="cameraPreview" autoplay playsinline muted></video>

          <div>
            <label style="font-size:0.8rem; color:#4b5563;">
              ‡πÄ‡∏ü‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Preview)
            </label>
            <img id="capturedImage" alt="‡πÄ‡∏ü‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö OCR" />
          </div>
        </div>

        <div id="scanStatus" class="status"></div>

        <p class="footer-note">
          ‚ö†Ô∏è ‡πÄ‡∏î‡πÇ‡∏°‡πà‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ OCR ‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (Tesseract.js) ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î ‡πÅ‡∏™‡∏á ‡πÅ‡∏•‡∏∞‡∏°‡∏∏‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á  
          ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ backend / encryption / PDPA / access control ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
        </p>
      </div>

      <!-- ‡∏Ç‡∏ß‡∏≤: ‡∏ü‡∏≠‡∏£‡πå‡∏° autofill -->
      <div class="card">
        <div class="pill">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2 : ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å OCR (autofill ‡∏ó‡∏∏‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå)</div>
        <div class="card-title">‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£</div>
        <p class="card-desc">
          ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° parse ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å OCR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•, ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥  
          ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </p>

        <form id="idForm" onsubmit="return false;">
          <div class="field">
            <label for="citizenId">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
            <input id="citizenId" name="citizenId" maxlength="13" />
          </div>

          <div class="field">
            <label for="firstName">‡∏ä‡∏∑‡πà‡∏≠</label>
            <input id="firstName" name="firstName" />
          </div>

          <div class="field">
            <label for="lastName">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
            <input id="lastName" name="lastName" />
          </div>

          <div class="field">
            <label for="dob">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î</label>
            <input id="dob" name="dob" placeholder="dd-mm-yyyy" />
          </div>

          <div class="field">
            <label for="address">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£</label>
            <textarea id="address" name="address" rows="3"></textarea>
          </div>

          <div class="field">
            <label for="ocrRaw">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å OCR (‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡∏î)</label>
            <textarea id="ocrRaw" rows="6" readonly></textarea>
          </div>

          <button
            type="button"
            class="btn btn-secondary"
            id="saveButton"
          >
            üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏î‡πÇ‡∏°‡πà)
          </button>
          <div id="saveStatus" class="status"></div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const openCameraButton = document.getElementById("openCameraButton");
    const stopScanButton = document.getElementById("stopScanButton");
    const cameraPreview = document.getElementById("cameraPreview");
    const capturedImage = document.getElementById("capturedImage");
    const scanStatus = document.getElementById("scanStatus");
    const saveButton = document.getElementById("saveButton");
    const saveStatus = document.getElementById("saveStatus");

    const citizenIdInput = document.getElementById("citizenId");
    const firstNameInput = document.getElementById("firstName");
    const lastNameInput = document.getElementById("lastName");
    const dobInput = document.getElementById("dob");
    const addressInput = document.getElementById("address");
    const ocrRawTextarea = document.getElementById("ocrRaw");

    let cameraStream = null;
    let scanIntervalId = null;
    let isScanningFrame = false;

    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á + ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    openCameraButton.addEventListener("click", async () => {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        scanStatus.textContent = "‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á (getUserMedia)";
        scanStatus.className = "status error";
        return;
      }

      try {
        scanStatus.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
        scanStatus.className = "status";

        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false,
        });

        cameraPreview.srcObject = cameraStream;
        openCameraButton.disabled = true;
        stopScanButton.disabled = false;

        scanStatus.textContent =
          "‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÄ‡∏≠‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡∏à‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÉ‡∏ô‡πÄ‡∏ü‡∏£‡∏° ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏•‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å ‡πÜ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ";
        scanStatus.className = "status success";

        cameraPreview.onloadedmetadata = () => {
          cameraPreview.play();
          startAutoScan();
        };
      } catch (error) {
        console.error("Error opening camera:", error);
        scanStatus.textContent =
          "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ (‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ô‡∏ö‡∏ô HTTPS)";
        scanStatus.className = "status error";
      }
    });

    function startAutoScan() {
      if (scanIntervalId) {
        clearInterval(scanIntervalId);
      }
      scanIntervalId = setInterval(() => {
        scanCurrentFrameWithOCR();
      }, 5000); // ‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥
    }

    function stopScanningAndCamera() {
      if (scanIntervalId) {
        clearInterval(scanIntervalId);
        scanIntervalId = null;
      }
      if (cameraStream) {
        cameraStream.getTracks().forEach((track) => track.stop());
        cameraStream = null;
      }
      cameraPreview.srcObject = null;

      openCameraButton.disabled = false;
      stopScanButton.disabled = true;

      scanStatus.textContent = "‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß";
      scanStatus.className = "status";
    }

    stopScanButton.addEventListener("click", () => {
      stopScanningAndCamera();
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å: OCR ‡∏à‡∏≤‡∏Å‡πÄ‡∏ü‡∏£‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á + parse ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå
    async function scanCurrentFrameWithOCR() {
      if (!cameraStream) return;
      if (isScanningFrame) return;

      const video = cameraPreview;
      if (!video.videoWidth || !video.videoHeight) {
        console.log("Video not ready yet");
        return;
      }

      isScanningFrame = true;
      scanStatus.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û‡∏™‡∏î...";
      scanStatus.className = "status";

      try {
        // 1) capture frame ‡∏à‡∏≤‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageDataUrl = canvas.toDataURL("image/png");
        capturedImage.src = imageDataUrl;
        capturedImage.style.display = "block";

        // 2) OCR ‡∏à‡∏£‡∏¥‡∏á‡∏î‡πâ‡∏ß‡∏¢ Tesseract
        const result = await Tesseract.recognize(imageDataUrl, "eng", {
          logger: (m) => console.log(m),
        });

        const text = (result.data && result.data.text) ? result.data.text : "";
        console.log("OCR text:", text);
        ocrRawTextarea.value = text.trim();

        // 3) ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô helper parse ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° OCR
        const fields = parseIdCardFields(text);

        citizenIdInput.value = fields.citizenId || "";
        firstNameInput.value = fields.firstName || "";
        lastNameInput.value = fields.lastName || "";
        dobInput.value = fields.dob || "";
        addressInput.value = fields.address || "";

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° status ‡∏ï‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á
        const found = [];
        if (fields.citizenId) found.push("‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£");
        if (fields.firstName || fields.lastName) found.push("‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•");
        if (fields.dob) found.push("‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î");
        if (fields.address) found.push("‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà");

        if (found.length > 0) {
          scanStatus.textContent =
            "‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å OCR ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + found.join(", ") + " (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)";
          scanStatus.className = "status success";
        } else {
          scanStatus.textContent =
            "‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á parse ‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ï‡∏£‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏¢‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
          scanStatus.className = "status error";
        }
      } catch (error) {
        console.error("OCR error:", error);
        scanStatus.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏≠‡πà‡∏≤‡∏ô OCR";
        scanStatus.className = "status error";
      } finally {
        isScanningFrame = false;
      }
    }

    // üß† ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô helper: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á citizenId, firstName, lastName, dob, address ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° OCR
    function parseIdCardFields(text) {
      const fields = {
        citizenId: "",
        firstName: "",
        lastName: "",
        dob: "",
        address: "",
      };

      if (!text) return fields;

      // ‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‡πÜ
      const lines = text
        .split(/\r?\n/)
        .map((l) => l.trim())
        .filter((l) => l.length > 0);

      // 1) ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ 13 ‡∏´‡∏•‡∏±‡∏Å (‡∏ï‡∏±‡∏î‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏Å)
      const digitsOnly = text.replace(/\D/g, "");
      const idMatch = digitsOnly.match(/(\d{13})/);
      if (idMatch) {
        fields.citizenId = idMatch[1];
      }

      // 2) ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: ‡∏´‡∏≤ pattern ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏á‡πà‡∏≤‡∏¢ ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô dd-mm-yyyy, dd/mm/yyyy, dd.mm.yyyy
      const dobMatch =
        text.match(/(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/) ||
        text.match(/(\d{1,2}\s+[A-Za-z]{3,}\s+\d{2,4})/); // 01 JAN 1990
      if (dobMatch) {
        fields.dob = dobMatch[1];
      }

      // 3) ‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:
      //    ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ Name / ‡∏ä‡∏∑‡πà‡∏≠ / ‡∏ô‡∏≤‡∏¢ / ‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß / ‡∏ô‡∏≤‡∏á / Mr / Miss
      let nameLine =
        lines.find((l) =>
          /(Name|‡∏ä‡∏∑‡πà‡∏≠|‡∏ô‡∏≤‡∏¢|‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß|‡∏ô‡∏≤‡∏á|Mr\.?|Mrs\.?|Miss)/i.test(l)
        ) || null;

      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏•‡∏≠‡∏á‡πÄ‡∏î‡∏≤‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ñ‡∏ß ‡πÜ ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 2-4
      if (!nameLine && lines.length >= 3) {
        nameLine = lines[2];
      }

      if (nameLine) {
        // ‡∏•‡∏ö‡∏Ñ‡∏≥ label ‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏ä‡πà‡∏ô Name, ‡∏ä‡∏∑‡πà‡∏≠, Surname, Last Name
        const cleaned = nameLine
          .replace(/(Name|‡∏ä‡∏∑‡πà‡∏≠|‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•|Surname|Last\s*Name|LastName)/gi, "")
          .trim();
        const tokens = cleaned.split(/\s+/).filter(Boolean);

        if (tokens.length >= 2) {
          fields.firstName = tokens[0];
          fields.lastName = tokens.slice(1).join(" ");
        } else if (tokens.length === 1) {
          fields.firstName = tokens[0];
        }
      }

      // 4) ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:
      //    ‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ Address / ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏£‡∏ß‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ñ‡∏±‡∏î ‡πÜ ‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô address
      let addrIndex = lines.findIndex((l) =>
        /(Address|‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà)/i.test(l)
      );
      if (addrIndex >= 0) {
        fields.address = lines.slice(addrIndex).join(" ");
      } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ label ‡πÄ‡∏•‡∏¢ ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡πÜ ‡πÄ‡∏õ‡πá‡∏ô address ‡πÅ‡∏ó‡∏ô
        if (lines.length >= 3) {
          fields.address = lines.slice(-3).join(" ");
        } else {
          fields.address = lines.join(" ");
        }
      }

      return fields;
    }

    // ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏î‡πÇ‡∏°‡πà)
    saveButton.addEventListener("click", () => {
      const payload = {
        citizenId: citizenIdInput.value,
        firstName: firstNameInput.value,
        lastName: lastNameInput.value,
        dob: dobInput.value,
        address: addressInput.value,
        ocrText: ocrRawTextarea.value,
      };

      console.log("Demo payload:", payload);
      saveStatus.textContent =
        "‡πÄ‡∏î‡πÇ‡∏°‡πà: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏•‡∏≠‡∏á‡∏î‡∏π‡πÉ‡∏ô Console ‡∏Ç‡∏≠‡∏á Browser)";
      saveStatus.className = "status success";
    });
  </script>
</body>
</html>
